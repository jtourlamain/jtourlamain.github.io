<!doctype html>

<html lang="en">

<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<!-- Page Info -->
	<link rel="shortcut icon" href="/assets/images/favicon.ico">
	<title>Azure table storage and complex types stored in Json – DevProtocol</title>
	<meta name="description" content="">

	<!-- Twitter Card -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Azure table storage and complex types stored in Json – DevProtocol">
	<meta name="twitter:description" content="">
	<meta name="twitter:image:src" content="https://www.devprotocol.com">

	<!-- Facebook OpenGraph -->
	<meta property="og:title" content="Azure table storage and complex types stored in Json – DevProtocol" />
	<meta property="og:description" content="" />
	<meta property="og:image" content="https://www.devprotocol.com" />

	
	<!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Muli:300,400,600,700" rel="stylesheet">
	

	<!-- Styles -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400%7CRoboto+Slab' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="/assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="/assets/css/font-awesome.min.css">
	<link rel="stylesheet" type="text/css" href="/assets/css/screen.css">

	<link rel="alternate" type="application/rss+xml"  href="https://www.devprotocol.com/feed.xml" title="DevProtocol">

	
	<!-- Custom Styles -->
	<style></style>
	

	
	<!-- Analytics Code -->
	
	

	
	<!-- Extra Header JS Code -->
	
	
	
</head>


<body class="home-template">


	<header class="main-header">
	<div class="container">
		<div class="row">
		<div class="col-sm-12">
			<a class="branding" href="/"><span class="mylogo">Dev</span>Protocol</a>
		</div>
		</div>
	</div>
</header>

<nav class="main-navigation">
	<div class="container">
		<div class="row">
			<div class="col-sm-12">
				<div class="navbar-header">
					<span class="nav-toggle-button collapsed" data-toggle="collapse" data-target="#main-menu">
					<span class="sr-only">Toggle navigation</span>
					<i class="fa fa-bars"></i>
					</span>
				</div>
				<div class="collapse navbar-collapse" id="main-menu">
					<ul class="menu">
						
						<li class="nav-home" role="presentation"><a href="/">Home</a></li>
						
						<li class="nav-home" role="presentation"><a href="/about">About</a></li>
						
					</ul>
				</div>
			</div>
		</div>
	</div>
</nav>


	<section class="content-wrap">

		<div class="container">
			<div class="row">
				<div class="col-md-8 main-content">

					<article class="post">
	<div class="post-head">
		<h2 class="post-title">Azure table storage and complex types stored in Json</h2>
		<div class="post-meta">
			
			<span class="author">By <a href="">Jan Tourlamain</a></span> &bull;
			
			<span class="date">February 18, 2016</span> &bull;
			<span class="comment-count"><a href="#disqus_thread">0 Comments</a></span>
		</div>
	</div>
	
	<div class="post-content">
		<p>Azure table storage only supports some types. You can find the list <a href="https://msdn.microsoft.com/en-us/library/azure/dd179338.aspx">here</a>. Complex types are not supported (maybe later they will be, but today it’s not the case).
I needed to store some data that is more complex than just a string. As I didn’t need to search on the objects themselves it was ok to store them as Json.</p>

<p>To make our lives easier, Microsoft added a TableEntity class in their library. If you inherit your domain object from TableEntity, you’ll be able to store your domain class in an azure table BUT only if it contains simple objects.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span><span class="p">:</span> <span class="n">TableEntity</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="kt">string</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
   
   <span class="c1">//The following property will NOT be stored in Azure</span>
   <span class="k">public</span> <span class="n">ContactData</span> <span class="n">ContactData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To store an instance of the Person class you can do the following:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddPerson</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">var</span> <span class="n">newPerson</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Person</span><span class="p">(){</span><span class="n">Id</span><span class="p">=</span><span class="s">"1"</span><span class="p">,</span> <span class="n">FirstName</span><span class="p">=</span><span class="s">"Bob"</span><span class="p">,</span> <span class="n">LastName</span><span class="p">=</span><span class="s">""</span><span class="p">};</span>
  <span class="n">CloudStorageAccount</span> <span class="n">storageAccount</span> <span class="p">=</span>   <span class="n">CloudStorageAccount</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">CloudConfigurationManager</span><span class="p">.</span><span class="nf">GetSetting</span><span class="p">(</span><span class="s">"StorageConnectionString"</span><span class="p">));</span>
  <span class="n">CloudTableClient</span> <span class="n">tableClient</span> <span class="p">=</span> <span class="n">storageAccount</span><span class="p">.</span><span class="nf">CreateCloudTableClient</span><span class="p">();</span>
  <span class="n">CloudTable</span> <span class="n">table</span> <span class="p">=</span> <span class="n">tableClient</span><span class="p">.</span><span class="nf">GetTableReference</span><span class="p">(</span><span class="s">"Persons"</span><span class="p">);</span>
  <span class="n">TableOperation</span> <span class="n">insertOperation</span> <span class="p">=</span> <span class="n">TableOperation</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="n">newPerson</span><span class="p">);</span>
  <span class="k">await</span> <span class="n">table</span><span class="p">.</span><span class="nf">ExecuteAsync</span><span class="p">(</span><span class="n">insertOperation</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There are 2 things to keep in mind:</p>

<ul>
  <li>The contactdata isn’t stored</li>
  <li>Treat Person as a domain object is strange because it isn’t just a POCO. It has a reference to Microsoft.WindowsAzure.Storage and it inherits from TableEntity. It doesn’t feel right to have that reference in each project that is linked to the domain.</li>
</ul>

<h2 id="store-your-complex-tableentity-property-in-azure-in-json">Store your complex TableEntity property in Azure in Json</h2>
<p>I wrote an attribute to decorate your property with to indicate that you want to serialize or deserialize that object to Json when stored or retrieved from Azure. The code and a demo can be downloaded from <a href="https://github.com/jtourlamain/DevProtocol.Azure.EntityPropertyConverter">my Github</a>.</p>

<p>Decorate your complex properties with the EntityPropertyConverterAttribute and override the ReadEntity en WriteEntity methods as follows:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">DevProtocol.Azure.EntityPropertyConverter</span><span class="p">;</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span><span class="p">:</span> <span class="n">TableEntity</span>
<span class="p">{</span>
   <span class="k">public</span> <span class="kt">string</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
   
   <span class="p">[</span><span class="n">EntityPropertyConverter</span><span class="p">]</span>
   <span class="k">public</span> <span class="n">ContactData</span> <span class="n">ContactData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="k">public</span> <span class="k">override</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">EntityProperty</span><span class="p">&gt;</span> <span class="nf">WriteEntity</span><span class="p">(</span><span class="n">OperationContext</span> <span class="n">operationContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="nf">WriteEntity</span><span class="p">(</span><span class="n">operationContext</span><span class="p">);</span>
            <span class="n">EntityPropertyConvert</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">results</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ReadEntity</span><span class="p">(</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">EntityProperty</span><span class="p">&gt;</span> <span class="n">properties</span><span class="p">,</span> <span class="n">OperationContext</span> <span class="n">operationContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">base</span><span class="p">.</span><span class="nf">ReadEntity</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">operationContext</span><span class="p">);</span>
            <span class="n">EntityPropertyConvert</span><span class="p">.</span><span class="nf">DeSerialize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="what-if-your-tableentity-property-is-an-interface">What if your TableEntity property is an interface?</h2>
<p>If you work with an interface I added an overload to the EntityPropertyConverterAttribute so you can define the type of the class that implements the interface.</p>

<p>When using the following interfaces:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IPerson</span>
<span class="p">{</span>
     <span class="kt">string</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
     <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
     <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> 
     <span class="n">IContactData</span> <span class="n">ContactData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IContactData</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">Email</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">string</span> <span class="n">Phone</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> 
<span class="p">}</span>
</code></pre></div></div>

<p>Your Person class becomes:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Person</span><span class="p">:</span> <span class="n">TableEntity</span><span class="p">,</span> <span class="n">IPerson</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">[</span><span class="nf">EntityPropertyConverter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ContactData</span><span class="p">))]</span>
        <span class="k">public</span> <span class="n">IContactData</span> <span class="n">ContactData</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">EntityProperty</span><span class="p">&gt;</span> <span class="nf">WriteEntity</span><span class="p">(</span><span class="n">OperationContext</span> <span class="n">operationContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="k">base</span><span class="p">.</span><span class="nf">WriteEntity</span><span class="p">(</span><span class="n">operationContext</span><span class="p">);</span>
            <span class="n">EntityPropertyConvert</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">results</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ReadEntity</span><span class="p">(</span><span class="n">IDictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">EntityProperty</span><span class="p">&gt;</span> <span class="n">properties</span><span class="p">,</span> <span class="n">OperationContext</span> <span class="n">operationContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">base</span><span class="p">.</span><span class="nf">ReadEntity</span><span class="p">(</span><span class="n">properties</span><span class="p">,</span> <span class="n">operationContext</span><span class="p">);</span>
            <span class="n">EntityPropertyConvert</span><span class="p">.</span><span class="nf">DeSerialize</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">properties</span><span class="p">);</span>
        <span class="p">}</span>
</code></pre></div></div>

<p>With the attribute it becomes simple to store your complex types in azure table storage. Let me know how you’re storing your complex types.</p>

<p>Download the code from <a href="https://github.com/jtourlamain/DevProtocol.Azure.EntityPropertyConverter">my Github</a></p>

	</div>
	<footer class="post-footer clearfix">
		<div class="pull-left tag-list">
			<i class="fa fa-folder-open-o"></i>
			
			
				
				<a href="/tag/azure/">azure</a>
				
			
		</div>

	</footer>
</article>
<div class="comment-wrap">
	
<div class="disqus-container">
    <div id="disqus_thread"></div>
    <script>
        /**
        *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
        /*
        var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };
        */
        (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://devprotocol.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</div>



				</div>

				<div class="col-md-4 sidebar">
        <div class="widget">
        <h4 class="title">Follow</h4>
        <div class="content">
            <ul class="social">
                <!-- start social links -->
                <li><a href="https://be.linkedin.com/in/jantourlamain"><i class="fa fa-linkedin"></i></a></li>
                <li><a href="https://github.com/jtourlamain"><i class="fa fa-github"></i></a></li>
                <li><a href="/feed.xml"><i class="fa fa-rss"></i></a></li>
                <!-- end social links -->
            </ul>
        </div>
    </div>
    <div class="widget">
    <h4 class="title">Recent Post</h4>
	<div class="content recent-post">
        
    <div class="recent-single-post">
      <a href="/2021/07/20/expose-openapi-documentation-on-azure-api-management.html" class="post-title">Expose openapi documentation on Azure API Management</a>
      <div class="date">July 20, 2021</div>
      </div>
      
    <div class="recent-single-post">
      <a href="/2020/01/28/use-policy-expressions-with-named-values-in-azure-api-management.html" class="post-title">Use policy expressions with named values in Azure API management</a>
      <div class="date">January 28, 2020</div>
      </div>
      
    <div class="recent-single-post">
      <a href="/2019/08/15/use-your-private-linked-arm-templates-with-ease.html" class="post-title">Use your private linked ARM templates with ease</a>
      <div class="date">August 15, 2019</div>
      </div>
      
  </div>
</div>
	    <div class="widget">
        <h4 class="title">Tags</h4>
        <div class="content tag-cloud">
            
            
            <a href="/tag/alm">alm</a>
            
            <a href="/tag/azure">azure</a>
            
            <a href="/tag/devops">devops</a>
            
            <a href="/tag/docker">docker</a>
            
            <a href="/tag/dotnet">dotnet</a>
            
            <a href="/tag/fsharp">fsharp</a>
            
            <a href="/tag/giraffe">giraffe</a>
            
            <a href="/tag/mobile">mobile</a>
            
            <a href="/tag/o365">o365</a>
            
            <a href="/tag/oauth2">oauth2</a>
            
            <a href="/tag/other">other</a>
            
            <a href="/tag/powershell">powershell</a>
            
            <a href="/tag/productivity">productivity</a>
            
            <a href="/tag/reactiveui">reactiveui</a>
            
            <a href="/tag/xamarin">xamarin</a>
            
        </div>
    </div>
</div>

			</div>
		</div>
	</section>


	<footer class="main-footer">

	<div class="container">
		<div class="row">
			<div class="col-sm-4">
				<div class="widget">
    <h4 class="title">Recent Post</h4>
	<div class="content recent-post">
        
    <div class="recent-single-post">
      <a href="/2021/07/20/expose-openapi-documentation-on-azure-api-management.html" class="post-title">Expose openapi documentation on Azure API Management</a>
      <div class="date">July 20, 2021</div>
      </div>
      
    <div class="recent-single-post">
      <a href="/2020/01/28/use-policy-expressions-with-named-values-in-azure-api-management.html" class="post-title">Use policy expressions with named values in Azure API management</a>
      <div class="date">January 28, 2020</div>
      </div>
      
    <div class="recent-single-post">
      <a href="/2019/08/15/use-your-private-linked-arm-templates-with-ease.html" class="post-title">Use your private linked ARM templates with ease</a>
      <div class="date">August 15, 2019</div>
      </div>
      
  </div>
</div>
			</div>
			<div class="col-sm-4">
				    <div class="widget">
        <h4 class="title">Tags</h4>
        <div class="content tag-cloud">
            
            
            <a href="/tag/alm">alm</a>
            
            <a href="/tag/azure">azure</a>
            
            <a href="/tag/devops">devops</a>
            
            <a href="/tag/docker">docker</a>
            
            <a href="/tag/dotnet">dotnet</a>
            
            <a href="/tag/fsharp">fsharp</a>
            
            <a href="/tag/giraffe">giraffe</a>
            
            <a href="/tag/mobile">mobile</a>
            
            <a href="/tag/o365">o365</a>
            
            <a href="/tag/oauth2">oauth2</a>
            
            <a href="/tag/other">other</a>
            
            <a href="/tag/powershell">powershell</a>
            
            <a href="/tag/productivity">productivity</a>
            
            <a href="/tag/reactiveui">reactiveui</a>
            
            <a href="/tag/xamarin">xamarin</a>
            
        </div>
    </div>
			</div>
			<div class="col-sm-4">
				&nbsp;
			</div>
			
		
		</div>
	</div>

</footer>


<div class="copyright">
	<div class="container">
		<div class="row">
			<div class="col-sm-12">
				Copyright &copy; 2021, <a href="https://www.devprotocol.com">DevProtocol</a>.  All Right Reserved
			</div>
		</div>
	</div>
</div>
<a href="#" id="back-to-top"><i class="fa fa-angle-up"></i></a>


	
	<!-- Extra Footer JS Code -->
	
	


</body>

</html>